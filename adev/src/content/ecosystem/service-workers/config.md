# Файл конфигурации Service Worker

В этой теме описываются свойства файла конфигурации Service Worker.

## Изменение конфигурации {#modifying-the-configuration}

Файл конфигурации JSON `ngsw-config.json` указывает, какие файлы и URL-адреса данных должен кешировать Angular Service Worker, и как он должен обновлять закешированные файлы и данные.
[Angular CLI](tools/cli) обрабатывает этот файл конфигурации во время выполнения команды `ng build`.

Все пути к файлам должны начинаться с `/`, что соответствует каталогу развертывания — обычно это `dist/<project-name>` в проектах CLI.

Если не указано иное, в шаблонах используется **ограниченный\*** формат glob, который внутренне преобразуется в регулярное выражение:

| Форматы Glob | Подробности                                                                                                         |
| :----------- | :------------------------------------------------------------------------------------------------------------------ |
| `**`         | Соответствует 0 или более сегментам пути                                                                            |
| `*`          | Соответствует 0 или более символам, исключая `/`                                                                    |
| `?`          | Соответствует ровно одному символу, исключая `/`                                                                    |
| Префикс `!`  | Помечает шаблон как отрицательный, означая, что включаются только файлы, которые *не* соответствуют данному шаблону |

<docs-callout important title="Специальные символы необходимо экранировать">
Обратите внимание, что некоторые символы, имеющие специальное значение в регулярных выражениях, не экранируются, а также шаблон не оборачивается в `^`/`$` при внутреннем преобразовании glob в регулярное выражение.

`$` — это специальный символ в регулярных выражениях, который соответствует концу строки и не будет автоматически экранирован при преобразовании glob-шаблона.

Если вы хотите буквально сопоставить символ `$`, вам нужно экранировать его самостоятельно (с помощью `\\$`). Например, glob-шаблон `/foo/bar/$value` приведет к выражению, которое невозможно сопоставить, так как строка не может содержать символы после своего окончания.

Шаблон не будет автоматически обернут в `^` и `$` при преобразовании в регулярное выражение. Следовательно, шаблоны будут частично совпадать с URL-адресами запросов.

Если вы хотите, чтобы ваши шаблоны соответствовали началу и/или концу URL-адресов, вы можете добавить `^`/`$` самостоятельно. Например, glob-шаблон `/foo/bar/*.js` будет соответствовать как файлам `.js`, так и `.json`. Если вы хотите сопоставить только файлы `.js`, используйте `/foo/bar/*.js$`.
</docs-callout>

Примеры шаблонов:

| Шаблоны      | Подробности                           |
| :----------- | :------------------------------------ |
| `/**/*.html` | Указывает все HTML-файлы              |
| `/*.html`    | Указывает только HTML-файлы в корне   |
| `!/**/*.map` | Исключает все карты кода (sourcemaps) |

## Свойства конфигурации Service Worker

В следующих разделах описывается каждое свойство файла конфигурации.

### `appData`

Этот раздел позволяет передавать любые данные, описывающие конкретную версию приложения.
Сервис `SwUpdate` включает эти данные в уведомления об обновлениях.
Многие приложения используют этот раздел для предоставления дополнительной информации для отображения всплывающих окон UI, уведомляющих пользователей о доступном обновлении.

### `index`

Указывает файл, который служит индексной страницей для удовлетворения навигационных запросов.
Обычно это `/index.html`.

### `assetGroups`

_Ассеты (Assets)_ — это ресурсы, являющиеся частью версии приложения, которые обновляются вместе с приложением.
Они могут включать ресурсы, загружаемые из источника (origin) страницы, а также сторонние ресурсы, загружаемые из CDN и других внешних URL-адресов.
Так как не все такие внешние URL могут быть известны во время сборки, можно использовать сопоставление по шаблонам URL.

HELPFUL: Чтобы Service Worker мог обрабатывать ресурсы, загружаемые из разных источников, убедитесь, что [CORS](https://developer.mozilla.org/docs/Web/HTTP/CORS) правильно настроен на сервере каждого источника.

Это поле содержит массив групп ресурсов, каждая из которых определяет набор ресурсов и политику их кеширования.

```ts
{
  "assetGroups": [
    {
      …
    },
    {
      …
    }
  ]
}
```

HELPFUL: Когда Service Worker обрабатывает запрос, он проверяет группы ресурсов в том порядке, в котором они появляются в `ngsw-config.json`.
Первая группа ресурсов, соответствующая запрошенному ресурсу, обрабатывает запрос.

Рекомендуется помещать более конкретные группы ресурсов выше в списке.
Например, группа ресурсов, соответствующая `/foo.js`, должна стоять перед группой, соответствующей `*.js`.

Каждая группа ресурсов указывает как группу ресурсов, так и политику, которая ими управляет.
Эта политика определяет, когда ресурсы загружаются и что происходит при обнаружении изменений.

Группы ресурсов следуют интерфейсу Typescript, показанному здесь:

```ts
interface AssetGroup {
  name: string;
  installMode?: 'prefetch' | 'lazy';
  updateMode?: 'prefetch' | 'lazy';
  resources: {
    files?: string[];
    urls?: string[];
  };
  cacheQueryOptions?: {
    ignoreSearch?: boolean;
  };
}
```

Каждая `AssetGroup` определяется следующими свойствами.

#### `name`

Свойство `name` является обязательным.
Оно идентифицирует эту конкретную группу ресурсов между версиями конфигурации.

#### `installMode`

Свойство `installMode` определяет, как эти ресурсы кешируются изначально.
`installMode` может принимать одно из двух значений:

| Значения   | Подробности                                                                                                                                                                                                                                                                                                                                                                               |
| :--------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `prefetch` | Сообщает Angular Service Worker загрузить каждый перечисленный ресурс во время кеширования текущей версии приложения. Это требует большой пропускной способности, но гарантирует доступность ресурсов при запросе, даже если браузер находится в автономном режиме (offline).                                                                                                             |
| `lazy`     | Не кеширует ресурсы заранее. Вместо этого Angular Service Worker кеширует только те ресурсы, для которых получает запросы. Это режим кеширования по требованию. Ресурсы, которые никогда не запрашиваются, не кешируются. Это полезно для таких вещей, как изображения в разных разрешениях, чтобы Service Worker кешировал только правильные ассеты для конкретного экрана и ориентации. |

По умолчанию установлено значение `prefetch`.

#### `updateMode`

Для ресурсов, уже находящихся в кеше, `updateMode` определяет поведение кеширования при обнаружении новой версии приложения.
Любые ресурсы в группе, которые изменились с момента предыдущей версии, обновляются в соответствии с `updateMode`.

| Значения   | Подробности                                                                                                                                                                                                                                                                                  |
| :--------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `prefetch` | Сообщает Service Worker немедленно загрузить и закешировать измененные ресурсы.                                                                                                                                                                                                              |
| `lazy`     | Сообщает Service Worker не кешировать эти ресурсы. Вместо этого он рассматривает их как незапрошенные и ждет, пока они снова не будут запрошены, прежде чем обновлять их. Значение `updateMode`, равное `lazy`, допустимо только в том случае, если `installMode` также установлен в `lazy`. |

По умолчанию используется значение, установленное в `installMode`.

#### `resources`

Этот раздел описывает ресурсы для кеширования, разбитые на следующие группы:

| Группы ресурсов | Подробности                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| :-------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `files`         | Перечисляет шаблоны, соответствующие файлам в каталоге дистрибутива. Это могут быть отдельные файлы или glob-подобные шаблоны, соответствующие ряду файлов.                                                                                                                                                                                                                                                                                         |
| `urls`          | Включает как URL-адреса, так и шаблоны URL, которые сопоставляются во время выполнения. Эти ресурсы не загружаются напрямую и не имеют хешей контента, но они кешируются в соответствии с их HTTP-заголовками. Это наиболее полезно для CDN, таких как сервис Google Fonts. <br /> _(Отрицательные glob-шаблоны не поддерживаются, а `?` будет сопоставляться буквально; то есть он не будет соответствовать никакому другому символу, кроме `?`.)_ |

#### `cacheQueryOptions`

Эти опции используются для изменения поведения сопоставления запросов.
Они передаются в функцию браузера `Cache#match`.
См. [MDN](https://developer.mozilla.org/docs/Web/API/Cache/match) для подробностей.
В настоящее время поддерживаются только следующие опции:

| Опции          | Подробности                                           |
| :------------- | :---------------------------------------------------- |
| `ignoreSearch` | Игнорировать параметры запроса. По умолчанию `false`. |

### `dataGroups`

В отличие от ресурсов (assets), запросы данных не версионируются вместе с приложением.
Они кешируются в соответствии с настроенными вручную политиками, которые более полезны для таких ситуаций, как запросы к API и другие зависимости данных.

Это поле содержит массив групп данных, каждая из которых определяет набор ресурсов данных и политику их кеширования.

```json
{
  "dataGroups": [
    {
      …
    },
    {
      …
    }
  ]
}
```

HELPFUL: Когда Service Worker обрабатывает запрос, он проверяет группы данных в том порядке, в котором они появляются в `ngsw-config.json`.
Первая группа данных, соответствующая запрошенному ресурсу, обрабатывает запрос.

Рекомендуется помещать более конкретные группы данных выше в списке.
Например, группа данных, соответствующая `/api/foo.json`, должна стоять перед группой, соответствующей `/api/*.json`.

Группы данных следуют этому интерфейсу Typescript:

```ts
export interface DataGroup {
  name: string;
  urls: string[];
  version?: number;
  cacheConfig: {
    maxSize: number;
    maxAge: string;
    timeout?: string;
    refreshAhead?: string;
    strategy?: 'freshness' | 'performance';
  };
  cacheQueryOptions?: {
    ignoreSearch?: boolean;
  };
}
```

Каждая `DataGroup` определяется следующими свойствами группы данных.

#### `name`

Аналогично `assetGroups`, каждая группа данных имеет `name`, которое уникально ее идентифицирует.

#### `urls`

Список шаблонов URL.
URL-адреса, соответствующие этим шаблонам, кешируются в соответствии с политикой этой группы данных.
Кешируются только не изменяющие данные запросы (GET и HEAD).

- Отрицательные glob-шаблоны не поддерживаются
- `?` сопоставляется буквально; то есть он соответствует _только_ символу `?`

#### `version`

Иногда API меняют форматы способом, не имеющим обратной совместимости.
Новая версия приложения может быть несовместима со старым форматом API и, следовательно, может быть несовместима с существующими закешированными ресурсами этого API.

`version` предоставляет механизм для указания того, что кешируемые ресурсы были обновлены способом, нарушающим обратную совместимость, и что старые записи кеша — от предыдущих версий — должны быть отброшены.

`version` является целочисленным полем и по умолчанию равно `1`.

#### `cacheConfig`

Следующие свойства определяют политику, по которой кешируются соответствующие запросы.

##### `maxSize`

Максимальное количество записей или ответов в кеше.

CRITICAL: Неограниченные кеши могут расти бесконтрольно и в конечном итоге превысить квоты хранилища, что приведет к удалению данных.

##### `maxAge`

Параметр `maxAge` указывает, как долго ответам разрешено оставаться в кеше, прежде чем они будут считаться недействительными и удалены. `maxAge` — это строка длительности, использующая следующие суффиксы единиц измерения:

| Суффиксы | Подробности  |
| :------- | :----------- |
| `d`      | Дни          |
| `h`      | Часы         |
| `m`      | Минуты       |
| `s`      | Секунды      |
| `u`      | Миллисекунды |

Например, строка `3d12h` кеширует контент на срок до трех с половиной дней.

##### `timeout`

Эта строка длительности указывает сетевой тайм-аут.
Сетевой тайм-аут — это время, в течение которого Angular Service Worker ждет ответа от сети, прежде чем использовать закешированный ответ, если это настроено.
`timeout` — это строка длительности, использующая следующие суффиксы единиц измерения:

| Суффиксы | Подробности  |
| :------- | :----------- |
| `d`      | Дни          |
| `h`      | Часы         |
| `m`      | Минуты       |
| `s`      | Секунды      |
| `u`      | Миллисекунды |

Например, строка `5s30u` означает пять секунд и 30 миллисекунд сетевого тайм-аута.

##### `refreshAhead`

Эта строка длительности указывает время до истечения срока действия закешированного ресурса, когда Angular Service Worker должен упреждающе попытаться обновить ресурс из сети.
Длительность `refreshAhead` — это необязательная конфигурация, которая определяет, за сколько времени до истечения срока действия закешированного ответа Service Worker должен инициировать запрос на обновление ресурса из сети.

| Суффиксы | Подробности  |
| :------- | :----------- |
| `d`      | Дни          |
| `h`      | Часы         |
| `m`      | Минуты       |
| `s`      | Секунды      |
| `u`      | Миллисекунды |

Например, строка `1h30m` означает один час и 30 минут до времени истечения срока действия.

##### `strategy`

Angular Service Worker может использовать одну из двух стратегий кеширования для ресурсов данных.

| Стратегии кеширования | Подробности                                                                                                                                                                                                                                                                                                                                                                 |
| :-------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `performance`         | По умолчанию, оптимизирует для максимально быстрых ответов. Если ресурс существует в кеше, используется закешированная версия, и сетевой запрос не выполняется. Это допускает некоторую устарелость данных, в зависимости от `maxAge`, в обмен на лучшую производительность. Подходит для ресурсов, которые меняются нечасто; например, изображения аватаров пользователей. |
| `freshness`           | Оптимизирует актуальность данных, предпочтительно запрашивая данные из сети. Только если происходит тайм-аут сети (в соответствии с `timeout`), запрос переключается на кеш. Это полезно для ресурсов, которые часто меняются; например, баланс счета.                                                                                                                      |

HELPFUL: Вы также можете эмулировать третью стратегию, [staleWhileRevalidate](https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook/#stale-while-revalidate), которая возвращает закешированные данные, если они доступны, но также загружает свежие данные из сети в фоновом режиме для следующего раза.
Чтобы использовать эту стратегию, установите `strategy` в `freshness` и `timeout` в `0u` в `cacheConfig`.

По сути, это делает следующее:

1.  Сначала пытается получить данные из сети.
2.  Если сетевой запрос не завершается немедленно (то есть после тайм-аута 0 мс), игнорирует возраст кеша и возвращает закешированное значение.
3.  Как только сетевой запрос завершится, обновляет кеш для будущих запросов.
4.  Если ресурс отсутствует в кеше, в любом случае ожидает выполнения сетевого запроса.

##### `cacheOpaqueResponses`

Должен ли Angular Service Worker кешировать непрозрачные ответы или нет.

Если не указано, значение по умолчанию зависит от настроенной стратегии группы данных:

| Стратегии                          | Подробности                                                                                                                                                                                                                                                                                                         |
| :--------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Группы со стратегией `freshness`   | Значение по умолчанию — `true`, и Service Worker кеширует непрозрачные ответы. Эти группы будут запрашивать данные каждый раз и переключаться на закешированный ответ только в автономном режиме или при медленной сети. Поэтому не имеет значения, закеширует ли Service Worker ответ с ошибкой.                   |
| Группы со стратегией `performance` | Значение по умолчанию — `false`, и Service Worker не кеширует непрозрачные ответы. Эти группы продолжали бы возвращать закешированный ответ до истечения `maxAge`, даже если ошибка была вызвана временной проблемой сети или сервера. Поэтому для Service Worker было бы проблематично кешировать ответ с ошибкой. |

<docs-callout title="Комментарий о непрозрачных ответах">

Если вы не знакомы, [непрозрачный ответ (opaque response)](https://fetch.spec.whatwg.org#concept-filtered-response-opaque) — это специальный тип ответа, возвращаемый при запросе ресурса, находящегося на другом источнике (origin), который не возвращает заголовки CORS.
Одной из характеристик непрозрачного ответа является то, что Service Worker не может прочитать его статус, то есть он не может проверить, был ли запрос успешным или нет.
См. [Введение в `fetch()`](https://developers.google.com/web/updates/2015/03/introduction-to-fetch#response_types) для получения дополнительной информации.

Если вы не можете реализовать CORS — например, если вы не контролируете источник — предпочтительнее использовать стратегию `freshness` для ресурсов, которые приводят к непрозрачным ответам.

</docs-callout>

#### `cacheQueryOptions`

См. [assetGroups](#assetgroups) для подробностей.

### `navigationUrls`

Этот необязательный раздел позволяет указать пользовательский список URL-адресов, которые будут перенаправлены на индексный файл.

#### Обработка навигационных запросов

Service Worker перенаправляет навигационные запросы, которые не соответствуют ни одной группе `asset` или `data`, на указанный [индексный файл](#index).
Запрос считается навигационным, если:

- Его [метод (method)](https://developer.mozilla.org/docs/Web/API/Request/method) — `GET`
- Его [режим (mode)](https://developer.mozilla.org/docs/Web/API/Request/mode) — `navigation`
- Он принимает ответ `text/html`, как определено значением заголовка `Accept`
- Его URL соответствует следующим критериям:
  - URL не должен содержать расширение файла (то есть `.`) в последнем сегменте пути
  - URL не должен содержать `__`

HELPFUL: Чтобы настроить, отправляются ли навигационные запросы в сеть или нет, см. разделы [navigationRequestStrategy](#navigationrequeststrategy) и [applicationMaxAge](#applicationmaxage).

#### Сопоставление URL навигационных запросов

Хотя эти критерии по умолчанию подходят в большинстве случаев, иногда желательно настроить другие правила.
Например, вы можете захотеть игнорировать определенные маршруты, такие как те, которые не являются частью приложения Angular, и передавать их на сервер.

Это поле содержит массив URL-адресов и [glob-подобных](#modifying-the-configuration) шаблонов URL, которые сопоставляются во время выполнения.
Оно может содержать как отрицательные шаблоны (то есть шаблоны, начинающиеся с `!`), так и неотрицательные шаблоны и URL-адреса.

Только запросы, чьи URL соответствуют _любому_ из неотрицательных URL/шаблонов и _ни одному_ из отрицательных, считаются навигационными запросами.
Строка запроса (query) URL игнорируется при сопоставлении.

Если поле опущено, оно по умолчанию равно:

```ts

[
'/**', // Включать все URL.
'!/**/*.*', // Исключать URL файлов (содержащие расширение файла в последнем сегменте).
'!/**/*__*', // Исключать URL, содержащие `__` в последнем сегменте.
'!/**/*__*/**', // Исключать URL, содержащие `__` в любом другом сегменте.
]

```

### `navigationRequestStrategy`

Это необязательное свойство позволяет настроить, как Service Worker обрабатывает навигационные запросы:

```json

{
  "navigationRequestStrategy": "freshness"
}
```

| Возможные значения | Подробности                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| :----------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `'performance'`    | Настройка по умолчанию. Отдает указанный [индексный файл](#index), который обычно закеширован.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `'freshness'`      | Передает запросы в сеть и переключается на поведение `performance` в автономном режиме. Это значение полезно, когда сервер перенаправляет навигационные запросы в другое место, используя код состояния перенаправления HTTP `3xx`. Причины использования этого значения включают: <ul> <li> Перенаправление на веб-сайт аутентификации, когда аутентификация не обрабатывается приложением </li> <li> Перенаправление определенных URL-адресов, чтобы избежать поломки существующих ссылок/закладок после редизайна веб-сайта </li> <li> Перенаправление на другой веб-сайт, например, на страницу статуса сервера, пока страница временно недоступна </li> </ul> |

IMPORTANT: Стратегия `freshness` обычно приводит к большему количеству запросов, отправляемых на сервер, что может увеличить задержку ответа. Рекомендуется использовать стратегию `performance` по умолчанию, когда это возможно.

### `applicationMaxAge`

Это необязательное свойство позволяет настроить, как долго Service Worker будет кешировать любые запросы. В пределах `maxAge` файлы будут отдаваться из кеша. По истечении этого времени все запросы будут обслуживаться только из сети, включая запросы ресурсов и данных.