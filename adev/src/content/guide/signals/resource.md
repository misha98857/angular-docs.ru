# Асинхронная реактивность с ресурсами

ВАЖНО: `resource` является [экспериментальным](reference/releases#experimental). Он готов к тому, чтобы вы его
попробовали, но может измениться до того, как станет стабильным.

Большинство API сигналов синхронны — `signal`, `computed`, `input` и т.д. Однако приложениям часто приходится работать с
данными, доступными асинхронно. `Resource` (Ресурс) дает вам способ внедрить асинхронные данные в код вашего приложения,
основанный на сигналах.

Вы можете использовать `Resource` для выполнения любых асинхронных операций, но наиболее частый сценарий использования
`Resource` — это получение данных с сервера. В следующем примере создается ресурс для получения данных пользователя.

Самый простой способ создать `Resource` — использовать функцию `resource`.

```typescript
import {resource, Signal} from '@angular/core';

const userId: Signal<string> = getUserId();

const userResource = resource({
  // Определяем реактивное вычисление.
  // Значение params пересчитывается при каждом изменении считываемых сигналов.
  params: () => ({id: userId()}),

  // Определяем асинхронный загрузчик, который получает данные.
  // Ресурс вызывает эту функцию каждый раз, когда изменяется значение `params`.
  loader: ({params}) => fetchUser(params),
});

// Создаем вычисляемый сигнал (computed) на основе результата функции загрузчика ресурса.
const firstName = computed(() => {
  if (userResource.hasValue()) {
    // `hasValue` служит двум целям:
    // - Действует как type guard, чтобы исключить `undefined` из типа
    // - Защищает от чтения `value`, которое может выбросить исключение, если ресурс находится в состоянии ошибки
    return userResource.value().firstName;
  }

  // запасной вариант (fallback) на случай, если значение ресурса `undefined` или ресурс находится в состоянии ошибки
  return undefined;
});
```

Функция `resource` принимает объект `ResourceOptions` с двумя основными свойствами: `params` и `loader`.

Свойство `params` определяет реактивное вычисление, которое создает значение параметра. Всякий раз, когда сигналы,
считанные в этом вычислении, изменяются, ресурс создает новое значение параметра, подобно `computed`.

Свойство `loader` определяет `ResourceLoader` — асинхронную функцию, которая получает некоторое состояние. Ресурс
вызывает загрузчик каждый раз, когда вычисление `params` выдает новое значение, передавая это значение в загрузчик.
См. [Загрузчики ресурсов](#resource-loaders) ниже для получения подробной информации.

У `Resource` есть сигнал `value`, который содержит результаты работы загрузчика.

## Загрузчики ресурсов

При создании ресурса вы указываете `ResourceLoader`. Этот загрузчик представляет собой асинхронную функцию, которая
принимает один параметр — объект `ResourceLoaderParams` — и возвращает значение.

Объект `ResourceLoaderParams` содержит три свойства: `params`, `previous` и `abortSignal`.

| Свойство      | Описание                                                                                                                                        |
| ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| `params`      | Значение вычисления `params` ресурса.                                                                                                           |
| `previous`    | Объект со свойством `status`, содержащим предыдущий `ResourceStatus`.                                                                           |
| `abortSignal` | [`AbortSignal`](https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal). См. [Отмена запросов](#aborting-requests) ниже для подробностей. |

Если вычисление `params` возвращает `undefined`, функция загрузчика не запускается, и статус ресурса становится
`'idle'`.

### Отмена запросов

Ресурс отменяет незавершенную операцию загрузки, если вычисление `params` изменяется во время загрузки ресурса.

Вы можете использовать `abortSignal` в `ResourceLoaderParams`, чтобы реагировать на отмененные запросы. Например,
нативная функция `fetch` принимает `AbortSignal`:

```typescript
const userId: Signal<string> = getUserId();

const userResource = resource({
  params: () => ({id: userId()}),
  loader: ({params, abortSignal}): Promise<User> => {
    // fetch отменяет любые незавершенные HTTP-запросы, когда переданный `AbortSignal`
    // указывает на то, что запрос был отменен.
    return fetch(`users/${params.id}`, {signal: abortSignal});
  },
});
```

См. [`AbortSignal` на MDN](https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal) для получения дополнительной
информации об отмене запросов с помощью `AbortSignal`.

### Перезагрузка

Вы можете программно запустить `loader` ресурса, вызвав метод `reload`.

```typescript
const userId: Signal<string> = getUserId();

const userResource = resource({
  params: () => ({id: userId()}),
  loader: ({params}) => fetchUser(params),
});

// ...

userResource.reload();
```

## Статус ресурса

Объект ресурса имеет несколько свойств-сигналов для чтения статуса асинхронного загрузчика.

| Свойство    | Описание                                                                                                  |
| ----------- | --------------------------------------------------------------------------------------------------------- |
| `value`     | Последнее значение ресурса или `undefined`, если значение не было получено.                               |
| `hasValue`  | Имеет ли ресурс значение.                                                                                 |
| `error`     | Последняя ошибка, возникшая при выполнении загрузчика ресурса, или `undefined`, если ошибка не произошла. |
| `isLoading` | Выполняется ли в данный момент загрузчик ресурса.                                                         |
| `status`    | Конкретный `ResourceStatus` ресурса, как описано ниже.                                                    |

Сигнал `status` предоставляет конкретный `ResourceStatus`, который описывает состояние ресурса с помощью строковой
константы.

| Статус        | `value()`                       | Описание                                                                   |
| ------------- | :------------------------------ | -------------------------------------------------------------------------- |
| `'idle'`      | `undefined`                     | У ресурса нет валидного запроса, и загрузчик не запускался.                |
| `'error'`     | `undefined`                     | В загрузчике произошла ошибка.                                             |
| `'loading'`   | `undefined`                     | Загрузчик выполняется в результате изменения значения `params`.            |
| `'reloading'` | Предыдущее значение             | Загрузчик выполняется в результате вызова метода `reload` ресурса.         |
| `'resolved'`  | Полученное значение             | Загрузчик завершил работу.                                                 |
| `'local'`     | Локально установленное значение | Значение ресурса было установлено локально через `.set()` или `.update()`. |

Вы можете использовать эту информацию о статусе для условного отображения элементов пользовательского интерфейса, таких
как индикаторы загрузки и сообщения об ошибках.

## Реактивное получение данных с помощью `httpResource`

[`httpResource`](/guide/http/http-resource) — это обертка вокруг `HttpClient`, которая предоставляет статус запроса и
ответ в виде сигналов. Она выполняет HTTP-запросы через HTTP-стек Angular, включая перехватчики (interceptors).
