# Утилиты для тестирования

NOTE: Хотя это руководство обновляется для Vitest, некоторые описания и примеры утилит в настоящее время представлены в контексте Karma/Jasmine. Мы активно работаем над предоставлением эквивалентов для Vitest и обновленных рекомендаций там, где это применимо.

На этой странице описаны наиболее полезные функции тестирования в Angular.

Утилиты тестирования Angular включают `TestBed`, `ComponentFixture` и несколько функций, управляющих тестовым окружением.
Классы [`TestBed`](#testbed-class-summary) и [`ComponentFixture`](#the-componentfixture) рассматриваются отдельно.

Вот краткая сводка автономных функций в порядке их полезности:

| Функция                      | Детали                                                                                                                                                                                                                                                          |
| :--------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `inject`                     | Внедряет один или несколько сервисов из текущего инжектора `TestBed` в функцию тестирования. Она не может внедрить сервис, предоставленный самим компонентом. См. обсуждение [debugElement.injector](guide/testing/components-scenarios#get-injected-services). |
| `ComponentFixtureAutoDetect` | Токен провайдера для сервиса, который включает [автоматическое обнаружение изменений](guide/testing/components-scenarios#automatic-change-detection).                                                                                                           |
| `getTestBed`                 | Получает текущий экземпляр `TestBed`. Обычно в этом нет необходимости, поскольку статических методов класса `TestBed` как правило достаточно. Экземпляр `TestBed` предоставляет несколько редко используемых членов, недоступных в виде статических методов.    |

Для обработки сложных асинхронных сценариев или тестирования устаревших приложений на основе Zone.js см. руководство [Утилиты тестирования Zone.js](guide/testing/zone-js-testing-utilities).

## Обзор класса `TestBed` {#testbed-class-summary}

Класс `TestBed` является одной из основных утилит тестирования Angular.
Его API довольно обширен и может показаться перегруженным, пока вы не изучите его постепенно.
Сначала прочитайте начальную часть этого руководства, чтобы освоить основы, прежде чем пытаться охватить полный API.

Определение модуля, передаваемое в `configureTestingModule`, является подмножеством свойств метаданных `@NgModule`.

<docs-code language="javascript">

type TestModuleMetadata = {
providers?: any[];
declarations?: any[];
imports?: any[];
schemas?: Array<SchemaMetadata | any[]>;
};

</docs-code>

Каждый метод переопределения принимает `MetadataOverride<T>`, где `T` — это вид метаданных, соответствующий методу, то есть параметр `@NgModule`, `@Component`, `@Directive` или `@Pipe`.

<docs-code language="javascript">

type MetadataOverride<T> = {
add?: Partial<T>;
remove?: Partial<T>;
set?: Partial<T>;
};

</docs-code>

API `TestBed` состоит из статических методов класса, которые либо обновляют, либо ссылаются на _глобальный_ экземпляр `TestBed`.

Внутри все статические методы вызывают методы текущего экземпляра `TestBed`, который также возвращается функцией `getTestBed()`.

Вызывайте методы `TestBed` _внутри_ `beforeEach()`, чтобы гарантировать чистое начало перед каждым отдельным тестом.

Вот наиболее важные статические методы в порядке их полезности.

| Методы                   | Детали                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| :----------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `configureTestingModule` | Тестовые заглушки устанавливают [начальное тестовое окружение](guide/testing) и модуль тестирования по умолчанию. Модуль тестирования по умолчанию настроен с базовыми декларациями и некоторыми заменителями сервисов Angular, необходимыми каждому тестировщику. <br /> Вызовите `configureTestingModule`, чтобы уточнить конфигурацию модуля тестирования для определенного набора тестов, добавляя и удаляя импорты, декларации (компонентов, директив и пайпов) и провайдеры.                                                                                                                                                                                          |
| `compileComponents`      | Асинхронно компилирует модуль тестирования после завершения его настройки. Вы **должны** вызвать этот метод, если _какой-либо_ из компонентов модуля тестирования имеет `templateUrl` или `styleUrls`, поскольку получение файлов шаблона и стилей компонента обязательно является асинхронным. См. [compileComponents](guide/testing/components-scenarios#calling-compilecomponents). <br /> После вызова `compileComponents` конфигурация `TestBed` замораживается на время выполнения текущей спецификации.                                                                                                                                                              |
| `createComponent<T>`     | Создает экземпляр компонента типа `T` на основе текущей конфигурации `TestBed`. После вызова `createComponent` конфигурация `TestBed` замораживается на время выполнения текущей спецификации.                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `overrideModule`         | Заменяет метаданные для данного `NgModule`. Напоминаем, что модули могут импортировать другие модули. Метод `overrideModule` может проникать глубоко в текущий модуль тестирования, чтобы изменить один из этих внутренних модулей.                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `overrideComponent`      | Заменяет метаданные для данного класса компонента, который может быть глубоко вложен во внутренний модуль.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `overrideDirective`      | Заменяет метаданные для данного класса директивы, который может быть глубоко вложен во внутренний модуль.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `overridePipe`           | Заменяет метаданные для данного класса pipe, который может быть глубоко вложен во внутренний модуль.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `inject`                 | Извлекает сервис из текущего инжектора `TestBed`. Функция `inject` часто подходит для этой цели. Но `inject` выбрасывает ошибку, если не может предоставить сервис. <br /> Что делать, если сервис является необязательным? <br /> Метод `TestBed.inject()` принимает необязательный второй параметр — объект, который нужно вернуть, если Angular не найдет провайдера (`null` в данном примере): <docs-code header="app/demo/demo.testbed.spec.ts" path="adev/src/content/examples/testing/src/app/demo/demo.testbed.spec.ts" region="testbed-get-w-null"/> После вызова `TestBed.inject` конфигурация `TestBed` замораживается на время выполнения текущей спецификации. |
| `initTestEnvironment`    | Инициализирует тестовое окружение для всего запуска тестов. <br /> Тестовые заглушки вызывают его за вас, поэтому редко возникает необходимость вызывать его самостоятельно. <br /> Вызывайте этот метод _ровно один раз_. Чтобы изменить это значение по умолчанию в середине запуска тестов, сначала вызовите `resetTestEnvironment`. <br /> Укажите фабрику компилятора Angular, `PlatformRef` и модуль тестирования Angular по умолчанию. Альтернативы для небраузерных платформ доступны в общем формате `@angular/platform-<platform_name>/testing/<platform_name>`.                                                                                                  |
| `resetTestEnvironment`   | Сбрасывает начальное тестовое окружение, включая модуль тестирования по умолчанию.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |

Некоторые методы экземпляра `TestBed` не охвачены статическими методами _класса_ `TestBed`.
Они требуются редко.

## `ComponentFixture` {#the-componentfixture}

Метод `TestBed.createComponent<T>` создает экземпляр компонента `T` и возвращает строго типизированный `ComponentFixture` для этого компонента.

Свойства и методы `ComponentFixture` предоставляют доступ к компоненту, его представлению в DOM и аспектам его окружения Angular.

### Свойства `ComponentFixture`

Вот наиболее важные свойства для тестировщиков в порядке их полезности.

| Свойства            | Детали                                                                                                                                                                                                                                                                                  |
| :------------------ | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `componentInstance` | Экземпляр класса компонента, созданный с помощью `TestBed.createComponent`.                                                                                                                                                                                                             |
| `debugElement`      | `DebugElement`, связанный с корневым элементом компонента. <br /> `debugElement` дает представление о компоненте и его DOM-элементе во время тестирования и отладки. Это критически важное свойство для тестировщиков. Наиболее интересные члены рассматриваются [ниже](#debugelement). |
| `nativeElement`     | Нативный DOM-элемент в корне компонента.                                                                                                                                                                                                                                                |
| `changeDetectorRef` | `ChangeDetectorRef` для компонента. <br /> `ChangeDetectorRef` наиболее ценен при тестировании компонента, который имеет стратегию `ChangeDetectionStrategy.OnPush`, или когда обнаружение изменений компонента находится под вашим программным контролем.                              |

### Методы `ComponentFixture`

Методы _фикстуры_ (fixture) заставляют Angular выполнять определенные задачи в дереве компонентов.
Вызывайте эти методы, чтобы инициировать поведение Angular в ответ на симуляцию действий пользователя.

Вот наиболее полезные методы для тестировщиков.

| Методы              | Детали                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| :------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `detectChanges`     | Запускает цикл обнаружения изменений для компонента. <br /> Вызывайте его для инициализации компонента (он вызывает `ngOnInit`) и после того, как ваш тестовый код изменит значения свойств привязки данных компонента. Angular не может видеть, что вы изменили `personComponent.name`, и не обновит привязку `name`, пока вы не вызовете `detectChanges`. <br /> Запускает `checkNoChanges` после этого, чтобы подтвердить отсутствие циклических обновлений, если не вызван как `detectChanges(false)`.                                                                                                                                                           |
| `autoDetectChanges` | Установите значение `true`, если вы хотите, чтобы фикстура автоматически обнаруживала изменения. <br /> Когда автоматическое обнаружение `true`, тестовая фикстура вызывает `detectChanges` сразу после создания компонента. Затем она прослушивает соответствующие события зоны и вызывает `detectChanges` соответствующим образом. Когда ваш тестовый код изменяет значения свойств компонента напрямую, вам, вероятно, все равно придется вызывать `fixture.detectChanges` для запуска обновлений привязки данных. <br /> Значение по умолчанию — `false`. Тестировщики, предпочитающие точный контроль над поведением теста, как правило, оставляют его `false`. |
| `checkNoChanges`    | Запускает проверку обнаружения изменений, чтобы убедиться в отсутствии ожидающих изменений. Выбрасывает исключение, если они есть.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `isStable`          | Если фикстура в данный момент _стабильна_, возвращает `true`. Если есть незавершенные асинхронные задачи, возвращает `false`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `whenStable`        | Возвращает промис, который разрешается, когда фикстура становится стабильной. <br /> Чтобы возобновить тестирование после завершения асинхронной активности или асинхронного обнаружения изменений, подключитесь к этому промису. См. [whenStable](guide/testing/components-scenarios#whenstable).                                                                                                                                                                                                                                                                                                                                                                   |
| `destroy`           | Инициирует уничтожение компонента.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |

#### `DebugElement` {#debugelement}

`DebugElement` предоставляет важную информацию о представлении компонента в DOM.

Из `DebugElement` корневого компонента теста, возвращаемого `fixture.debugElement`, вы можете обойти (и выполнить запрос к) все дерево элементов и компонентов фикстуры.

Вот наиболее полезные члены `DebugElement` для тестировщиков, в приблизительном порядке полезности:

| Члены                 | Детали                                                                                                                                                                                                                                                                                                                                                                                          |
| :-------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `nativeElement`       | Соответствующий DOM-элемент в браузере.                                                                                                                                                                                                                                                                                                                                                         |
| `query`               | Вызов `query(predicate: Predicate<DebugElement>)` возвращает первый `DebugElement`, который соответствует предикату на любой глубине в поддереве.                                                                                                                                                                                                                                               |
| `queryAll`            | Вызов `queryAll(predicate: Predicate<DebugElement>)` возвращает все `DebugElement`, которые соответствуют предикату на любой глубине в поддереве.                                                                                                                                                                                                                                               |
| `injector`            | Инжектор зависимостей хоста. Например, инжектор экземпляра компонента корневого элемента.                                                                                                                                                                                                                                                                                                       |
| `componentInstance`   | Собственный экземпляр компонента элемента, если он есть.                                                                                                                                                                                                                                                                                                                                        |
| `context`             | Объект, предоставляющий родительский контекст для этого элемента. Часто это экземпляр компонента-предка, который управляет этим элементом. <br /> Когда элемент повторяется внутри блока `@for`, контекстом является `RepeaterContext`, чье свойство `$implicit` является значением экземпляра строки. Например, `hero` в `@for(hero of heroes; ...)`.                                          |
| `children`            | Непосредственные дочерние элементы `DebugElement`. Проходите по дереву, спускаясь через `children`. У `DebugElement` также есть `childNodes`, список объектов `DebugNode`. `DebugElement` наследуется от объектов `DebugNode`, и часто узлов больше, чем элементов. Тестировщики обычно могут игнорировать простые узлы.                                                                        |
| `parent`              | Родительский `DebugElement`. Null, если это корневой элемент.                                                                                                                                                                                                                                                                                                                                   |
| `name`                | Имя тега элемента, если это элемент.                                                                                                                                                                                                                                                                                                                                                            |
| `triggerEventHandler` | Запускает событие по его имени, если в коллекции `listeners` элемента есть соответствующий слушатель. Второй параметр — это _объект события_, ожидаемый обработчиком. См. [triggerEventHandler](guide/testing/components-scenarios#trigger-event-handler). <br /> Если у события нет слушателя или есть какая-то другая проблема, рассмотрите вызов `nativeElement.dispatchEvent(eventObject)`. |
| `listeners`           | Обратные вызовы (callbacks), прикрепленные к свойствам `@Output` компонента и/или свойствам событий элемента.                                                                                                                                                                                                                                                                                   |
| `providerTokens`      | Токены поиска инжектора этого компонента. Включает сам компонент плюс токены, которые компонент перечисляет в своих метаданных `providers`.                                                                                                                                                                                                                                                     |
| `source`              | Где найти этот элемент в шаблоне исходного компонента.                                                                                                                                                                                                                                                                                                                                          |
| `references`          | Словарь объектов, связанных с локальными переменными шаблона (например, `#foo`), с ключами по имени локальной переменной.                                                                                                                                                                                                                                                                       |

Методы `DebugElement.query(predicate)` и `DebugElement.queryAll(predicate)` принимают предикат, который фильтрует поддерево исходного элемента для поиска подходящих `DebugElement`.

Предикат — это любой метод, который принимает `DebugElement` и возвращает _истинное_ (truthy) значение.
Следующий пример находит все `DebugElement` со ссылкой на локальную переменную шаблона с именем "content":

<docs-code header="demo.testbed.spec.ts" path="adev/src/content/examples/testing/src/app/demo/demo.testbed.spec.ts" region="custom-predicate"/>

Класс Angular `By` имеет три статических метода для общих предикатов:

| Статический метод         | Детали                                                                         |
| :------------------------ | :----------------------------------------------------------------------------- |
| `By.all`                  | Возвращает все элементы                                                        |
| `By.css(selector)`        | Возвращает элементы с соответствующими CSS-селекторами                         |
| `By.directive(directive)` | Возвращает элементы, которые Angular сопоставил с экземпляром класса директивы |

<docs-code header="hero-list.component.spec.ts" path="adev/src/content/examples/testing/src/app/hero/hero-list.component.spec.ts" region="by"/>
