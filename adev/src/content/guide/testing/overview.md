# Модульное тестирование

Тестирование приложения Angular помогает убедиться, что оно работает так, как ожидается. Модульные тесты имеют решающее
значение для раннего обнаружения ошибок, обеспечения качества кода и безопасного рефакторинга.

ПРИМЕЧАНИЕ: Это руководство посвящено настройке тестирования по умолчанию для новых проектов Angular CLI. Если вы
переносите существующий проект с Karma на Vitest,
см. [Руководство по миграции с Karma на Vitest](guide/testing/migrating-to-vitest). Хотя Vitest является инструментом
запуска тестов по умолчанию, Karma по-прежнему полностью поддерживается. Информацию о тестировании с помощью Karma см.
в [Руководстве по тестированию с Karma](guide/testing/karma).

## Настройка для тестирования

Angular CLI загружает и устанавливает все необходимое для тестирования приложения Angular с
использованием [фреймворка тестирования Vitest](https://vitest.dev). По умолчанию новые проекты включают `vitest` и
`jsdom`.

Vitest запускает модульные тесты в среде Node.js, используя `jsdom` для эмуляции DOM. Это позволяет ускорить выполнение
тестов, избегая накладных расходов на запуск браузера. Вы также можете использовать `happy-dom` в качестве альтернативы,
установив его и удалив `jsdom`. CLI автоматически обнаружит и будет использовать `happy-dom`, если он присутствует.

Проект, созданный с помощью CLI, сразу готов к тестированию. Просто запустите команду CLI [`ng test`](cli/test):

```shell
ng test
```

Команда `ng test` собирает приложение в _режиме наблюдения_ (watch mode) и
запускает [инструмент запуска тестов Vitest](https://vitest.dev).

Вывод консоли выглядит следующим образом:

```shell
 ✓ src/app/app.spec.ts (3)
   ✓ AppComponent should create the app
   ✓ AppComponent should have as title 'my-app'
   ✓ AppComponent should render title
 Test Files  1 passed (1)
      Tests  3 passed (3)
   Start at  18:18:01
   Duration  2.46s (transform 615ms, setup 2ms, collect 2.21s, tests 5ms)
```

Команда `ng test` также отслеживает изменения. Чтобы увидеть это в действии, внесите небольшое изменение в `app.ts` и
сохраните его. Тесты запустятся снова, и новые результаты появятся в консоли.

## Конфигурация

Angular CLI берет на себя большую часть настройки Vitest. Для многих распространенных случаев использования вы можете
настроить поведение тестов, изменив параметры непосредственно в файле `angular.json`.

### Встроенные параметры конфигурации

Вы можете изменить следующие параметры в целевом объекте `test` вашего файла `angular.json`:

- `include`: Шаблоны glob для файлов, включаемых в тестирование. По умолчанию `['**/*.spec.ts', '**/*.test.ts']`.
- `exclude`: Шаблоны glob для файлов, исключаемых из тестирования.
- `setupFiles`: Список путей к файлам глобальной настройки (например, полифилы или глобальные моки), которые выполняются
  перед тестами.
- `providersFile`: Путь к файлу, экспортирующему массив провайдеров Angular по умолчанию для тестовой среды. Это полезно
  для настройки глобальных тестовых провайдеров, которые внедряются в ваши тесты.
- `coverage`: Логическое значение для включения или отключения отчетов о покрытии кода. По умолчанию `false`.
- `browsers`: Массив имен браузеров для запуска тестов (например, `["chromium"]`). Требует установки провайдера
  браузера.

Например, вы можете создать файл `src/test-providers.ts`, чтобы предоставить `provideHttpClientTesting` всем вашим
тестам:

```typescript
import { Provider } from '@angular/core';
import { provideHttpClient } from '@angular/common/http';
import { provideHttpClientTesting } from '@angular/common/http/testing';

const testProviders: Provider[] = [
  provideHttpClient(),
  provideHttpClientTesting(),
];

export default testProviders;
```

Затем вы укажете этот файл в вашем `angular.json`:

```json
{
  "projects": {
    "your-project-name": {
      "architect": {
        "test": {
          "builder": "@angular/build:unit-test",
          "options": {
            "include": ["src/**/*.spec.ts"],
            "setupFiles": ["src/test-setup.ts"],
            "providersFile": "src/test-providers.ts",
            "coverage": true,
            "browsers": ["chromium"]
          }
        }
      }
    }
  }
}
```

### Продвинутый уровень: Пользовательская конфигурация Vitest

Для сложных случаев использования вы можете предоставить собственный файл конфигурации Vitest.

ВАЖНО: Хотя использование пользовательской конфигурации открывает доступ к расширенным опциям, команда Angular не
предоставляет прямую поддержку конкретного содержимого файла конфигурации или любых сторонних плагинов, используемых в
нем. CLI также переопределит определенные свойства (`test.projects`, `test.include`) для обеспечения правильной работы.

Вы можете создать файл конфигурации Vitest (например, `vitest-base.config.ts`) и сослаться на него в `angular.json`,
используя опцию `runnerConfig`.

```json
{
  "projects": {
    "your-project-name": {
      "architect": {
        "test": {
          "builder": "@angular/build:unit-test",
          "options": {
            "runnerConfig": "vitest-base.config.ts"
          }
        }
      }
    }
  }
}
```

Вы также можете сгенерировать базовый файл конфигурации с помощью CLI:

```shell
ng generate config vitest
```

Это создаст файл `vitest-base.config.ts`, который вы сможете настроить.

ПОЛЕЗНО: Подробнее о конфигурации Vitest читайте в [руководстве по конфигурации Vitest](https://vitest.dev/config/).

## Покрытие кода

Вы можете генерировать отчеты о покрытии кода, добавив флаг `--coverage` к команде `ng test`. Отчет генерируется в
каталоге `coverage/`.

Для получения более подробной информации о предварительных требованиях, обеспечении пороговых значений покрытия и
расширенной настройке см. [Руководство по покрытию кода](guide/testing/code-coverage).

## Запуск тестов в браузере

Хотя среда Node.js по умолчанию быстрее для большинства модульных тестов, вы также можете запускать тесты в реальном
браузере. Это полезно для тестов, зависящих от специфичных для браузера API (например, рендеринга), или для отладки.

Чтобы запустить тесты в браузере, сначала необходимо установить провайдер браузера.
Выберите один из следующих провайдеров браузера в зависимости от ваших потребностей:

- **Playwright**: `@vitest/browser-playwright` для Chromium, Firefox и WebKit.
- **WebdriverIO**: `@vitest/browser-webdriverio` для Chrome, Firefox, Safari и Edge.
- **Preview**: `@vitest/browser-preview` для сред Webcontainer (например, StackBlitz).

<docs-code-multifile>
  <docs-code header="npm" language="shell">
    npm install --save-dev @vitest/browser-playwright playwright
  </docs-code>
  <docs-code header="yarn" language="shell">
    yarn add --dev @vitest/browser-playwright playwright
  </docs-code>
  <docs-code header="pnpm" language="shell">
    pnpm add -D @vitest/browser-playwright playwright
  </docs-code>
  <docs-code header="bun" language="shell">
    bun add --dev @vitest/browser-playwright playwright
  </docs-code>
</docs-code-multifile>

После установки провайдера вы можете запускать тесты в браузере, используя флаг `--browsers`:

```bash
# Example for Playwright
ng test --browsers=chromium

# Example for WebdriverIO
ng test --browsers=chrome
```

Headless-режим включается автоматически, если установлена переменная окружения `CI`. В противном случае тесты будут
запускаться в браузере с графическим интерфейсом.

## Другие фреймворки тестирования

Вы также можете проводить модульное тестирование приложения Angular с помощью других библиотек тестирования и
инструментов запуска тестов. Каждая библиотека и инструмент имеют свои собственные процедуры установки, конфигурацию и
синтаксис.

## Тестирование в непрерывной интеграции

Надежный набор тестов является ключевой частью конвейера непрерывной интеграции (CI). Серверы CI позволяют настроить
репозиторий проекта так, чтобы тесты запускались при каждом коммите и pull request.

Чтобы протестировать приложение Angular на сервере непрерывной интеграции (CI), обычно можно запустить стандартную
команду тестирования:

```shell
ng test
```

Большинство серверов CI устанавливают переменную окружения `CI=true`, которую обнаруживает `ng test`. Это автоматически
запускает тесты в соответствующем неинтерактивном режиме однократного запуска.

Если ваш сервер CI не устанавливает эту переменную или если вам нужно принудительно включить режим однократного запуска
вручную, вы можете использовать флаги `--no-watch` и `--no-progress`:

```shell
ng test --no-watch --no-progress
```

## Дополнительная информация о тестировании

После настройки приложения для тестирования вам могут пригодиться следующие руководства по тестированию.

|                                                                         | Подробности                                                                  |
| :---------------------------------------------------------------------- | :--------------------------------------------------------------------------- |
| [Покрытие кода](guide/testing/code-coverage)                            | Насколько ваше приложение покрыто тестами и как задать требуемые показатели. |
| [Тестирование сервисов](guide/testing/services)                         | Как тестировать сервисы, используемые вашим приложением.                     |
| [Основы тестирования компонентов](guide/testing/components-basics)      | Основы тестирования компонентов Angular.                                     |
| [Сценарии тестирования компонентов](guide/testing/components-scenarios) | Различные виды сценариев и вариантов использования тестирования компонентов. |
| [Тестирование директив атрибутов](guide/testing/attribute-directives)   | Как тестировать ваши директивы атрибутов.                                    |
| [Тестирование пайпов](guide/testing/pipes)                              | Как тестировать пайпы.                                                       |
| [Отладка тестов](guide/testing/debugging)                               | Распространенные ошибки тестирования.                                        |
| [Утилиты тестирования API](guide/testing/utility-apis)                  | Возможности тестирования Angular.                                            |
