# Гидратация

## Что такое гидратация

Гидратация — это процесс, который восстанавливает приложение, отрендеренное на сервере, на стороне клиента. Это включает
повторное использование DOM-структур, созданных сервером, сохранение состояния приложения, передачу данных, уже
полученных сервером, и другие процессы.

## Почему гидратация важна?

Гидратация улучшает производительность приложения, избегая лишней работы по пересозданию DOM-узлов. Вместо этого Angular
пытается сопоставить существующие DOM-элементы со структурой приложения во время выполнения и повторно использует
DOM-узлы, когда это возможно. Это приводит к улучшению производительности, которое можно измерить с помощью
статистики [Core Web Vitals (CWV)](https://web.dev/learn-core-web-vitals/), такой как уменьшение задержки первого
ввода ([FID](https://web.dev/fid/)) и отрисовки самого крупного контента ([LCP](https://web.dev/lcp/)), а также
совокупного сдвига макета ([CLS](https://web.dev/cls/)). Улучшение этих показателей также влияет на SEO.

Без включенной гидратации Angular-приложения, отрендеренные на сервере, уничтожают и заново рендерят DOM приложения, что
может привести к видимому мерцанию интерфейса. Этот повторный рендеринг может негативно повлиять
на [Core Web Vitals](https://web.dev/learn-core-web-vitals/), такие как [LCP](https://web.dev/lcp/), и вызвать сдвиг
макета. Включение гидратации позволяет повторно использовать существующий DOM и предотвращает мерцание.

## Как включить гидратацию в Angular

Гидратацию можно включить только для приложений с серверным рендерингом (SSR). Сначала
следуйте [Руководству по Angular SSR](guide/ssr), чтобы включить рендеринг на стороне сервера.

### Использование Angular CLI

Если вы использовали Angular CLI для включения SSR (либо при создании приложения, либо позже через
`ng add @angular/ssr`), код, включающий гидратацию, уже должен быть добавлен в ваше приложение.

### Ручная настройка

Если у вас кастомная настройка и вы не использовали Angular CLI для включения SSR, вы можете включить гидратацию
вручную. Для этого перейдите в основной компонент или модуль приложения и импортируйте `provideClientHydration` из
`@angular/platform-browser`. Затем добавьте этот провайдер в список провайдеров начальной загрузки (bootstrapping)
вашего приложения.

```typescript
import {
  bootstrapApplication,
  provideClientHydration,
} from '@angular/platform-browser';
...

bootstrapApplication(AppComponent, {
  providers: [provideClientHydration()]
});
```

Альтернативно, если вы используете NgModules, добавьте `provideClientHydration` в список провайдеров корневого модуля
приложения.

```typescript
import {provideClientHydration} from '@angular/platform-browser';
import {NgModule} from '@angular/core';

@NgModule({
  declarations: [AppComponent],
  exports: [AppComponent],
  bootstrap: [AppComponent],
  providers: [provideClientHydration()],
})
export class AppModule {}
```

ВАЖНО: Убедитесь, что вызов `provideClientHydration()` также включен в набор провайдеров, используемых для начальной
загрузки приложения на **сервере**. В приложениях со стандартной структурой проекта (созданной командой `ng new`)
добавления вызова в корневой `AppModule` должно быть достаточно, так как этот модуль импортируется серверным модулем.
Если вы используете кастомную настройку, добавьте вызов `provideClientHydration()` в список провайдеров в конфигурации
серверной загрузки.

### Проверка включения гидратации

После настройки гидратации и запуска сервера загрузите приложение в браузере.

ПОЛЕЗНО: Вероятно, вам потребуется исправить случаи прямого манипулирования DOM, прежде чем гидратация заработает
полностью, либо перейдя на конструкции Angular, либо используя `ngSkipHydration`. См.
разделы [Ограничения](#constraints), [Прямое манипулирование DOM](#direct-dom-manipulation)
и [Как пропустить гидратацию для конкретных компонентов](#how-to-skip-hydration-for-particular-components) для получения
подробной информации.

При запуске приложения в режиме разработки вы можете подтвердить, что гидратация включена, открыв инструменты
разработчика в браузере и просмотрев консоль. Вы должны увидеть сообщение, содержащее статистику, связанную с
гидратацией, например, количество гидратированных компонентов и узлов. Angular рассчитывает статистику на основе всех
компонентов, отрендеренных на странице, включая те, что поступают из сторонних библиотек.

Вы также можете использовать [расширение браузера Angular DevTools](tools/devtools), чтобы увидеть статус гидратации
компонентов на странице. Angular DevTools также позволяет включить оверлей, указывающий, какие части страницы были
гидратированы. Если возникнет ошибка несоответствия гидратации, DevTools также подсветит компонент, вызвавший ошибку.

## Захват и воспроизведение событий (Event Replay)

Когда приложение рендерится на сервере, оно становится видимым в браузере сразу после загрузки созданного HTML.
Пользователи могут предположить, что могут взаимодействовать со страницей, но слушатели событий не прикрепляются до
завершения гидратации. Начиная с v18, вы можете включить функцию Event Replay (воспроизведение событий), которая
позволяет перехватывать все события, происходящие до гидратации, и воспроизводить их после завершения гидратации. Вы
можете включить её с помощью функции `withEventReplay()`, например:

```typescript
import {provideClientHydration, withEventReplay} from '@angular/platform-browser';

bootstrapApplication(App, {
  providers: [
    provideClientHydration(withEventReplay())
  ]
});
```

### Как работает воспроизведение событий

Event Replay — это функция, улучшающая пользовательский опыт за счет перехвата событий пользователя, вызванных до
завершения процесса гидратации. Затем эти события воспроизводятся, гарантируя, что ни одно взаимодействие не будет
потеряно.

Event Replay делится на три основных этапа:

- **Захват взаимодействий пользователя**<br>
  До **Гидратации** Event Replay перехватывает и сохраняет все взаимодействия, которые может выполнить пользователь,
  такие как клики и другие нативные события браузера.

- **Сохранение событий**<br>
  **Контракт событий (Event Contract)** хранит в памяти все взаимодействия, записанные на предыдущем шаге, гарантируя,
  что они не будут потеряны для последующего воспроизведения.

- **Перезапуск событий**<br>
  Как только **Гидратация** завершена, Angular повторно вызывает перехваченные события.

Воспроизведение событий поддерживает _нативные события браузера_, например `click`, `mouseover` и `focusin`. Если вы
хотите узнать больше о JSAction, библиотеке, обеспечивающей работу воспроизведения событий, вы можете прочитать
подробнее [в readme](https://github.com/angular/angular/tree/main/packages/core/primitives/event-dispatch#readme).

---

Эта функция обеспечивает согласованный пользовательский опыт, предотвращая игнорирование действий пользователя,
выполненных до гидратации. ПРИМЕЧАНИЕ: если у вас включена [инкрементальная гидратация](guide/incremental-hydration),
воспроизведение событий включается автоматически "под капотом".

## Ограничения {#constraints}

Гидратация накладывает на ваше приложение несколько ограничений, которые отсутствуют без неё. Ваше приложение должно
иметь одинаковую сгенерированную структуру DOM как на сервере, так и на клиенте. Процесс гидратации ожидает, что дерево
DOM будет иметь одинаковую структуру в обоих местах. Это также касается пробелов и узлов комментариев, которые Angular
создает во время рендеринга на сервере. Эти пробелы и узлы должны присутствовать в HTML, сгенерированном процессом
серверного рендеринга.

ВАЖНО: HTML, созданный операцией серверного рендеринга, **не должен** изменяться между сервером и клиентом.

Если существует несоответствие между структурами дерева DOM сервера и клиента, процесс гидратации столкнется с
проблемами при попытке сопоставить ожидаемое с тем, что фактически присутствует в DOM. Компоненты, выполняющие прямое
манипулирование DOM с использованием нативных API DOM, являются наиболее частой причиной этого.

### Прямое манипулирование DOM {#direct-dom-manipulation}

Если у вас есть компоненты, которые манипулируют DOM с использованием нативных API DOM или используют `innerHTML` или
`outerHTML`, процесс гидратации столкнется с ошибками. Конкретными случаями, когда манипулирование DOM является
проблемой, являются такие ситуации, как доступ к `document`, запрос конкретных элементов и внедрение дополнительных
узлов с помощью `appendChild`. Отсоединение узлов DOM и перемещение их в другие места также приведет к ошибкам.

Это происходит потому, что Angular не знает об этих изменениях DOM и не может разрешить их в процессе гидратации.
Angular будет ожидать определенную структуру, но столкнется с другой структурой при попытке гидратации. Это
несоответствие приведет к сбою гидратации и выдаст ошибку несоответствия DOM ([см. ниже](#errors)).

Лучше всего отрефакторить ваш компонент, чтобы избежать такого рода манипуляций с DOM. Старайтесь использовать API
Angular для выполнения этой работы, если это возможно. Если вы не можете изменить это поведение, используйте атрибут
`ngSkipHydration` ([описанный ниже](#how-to-skip-hydration-for-particular-components)), пока не сможете переработать код
в решение, совместимое с гидратацией.

### Валидная структура HTML {#valid-html-structure}

Существует несколько случаев, когда наличие шаблона компонента с невалидной HTML-структурой может привести к ошибке
несоответствия DOM во время гидратации.

В качестве примера, вот некоторые из наиболее распространенных случаев этой проблемы:

- `<table>` без `<tbody>`
- `<div>` внутри `<p>`
- `<a>` внутри другого `<a>`

Если вы не уверены, является ли ваш HTML валидным, вы можете
использовать [валидатор синтаксиса](https://validator.w3.org/) для его проверки.

ПРИМЕЧАНИЕ: Хотя стандарт HTML не требует наличия элемента `<tbody>` внутри таблиц, современные браузеры автоматически
создают элемент `<tbody>` в таблицах, где он не объявлен. Из-за этой несогласованности всегда явно объявляйте элемент
`<tbody>` в таблицах, чтобы избежать ошибок гидратации.

### Конфигурация сохранения пробелов (Preserve Whitespaces)

При использовании функции гидратации мы рекомендуем использовать значение по умолчанию `false` для
`preserveWhitespaces`. Если эта настройка отсутствует в вашем tsconfig, значение будет `false`, и никаких изменений не
требуется. Если вы решите включить сохранение пробелов, добавив `preserveWhitespaces: true` в ваш tsconfig, возможно, вы
столкнетесь с проблемами при гидратации. Эта конфигурация пока не поддерживается полностью.

ПОЛЕЗНО: Убедитесь, что эта настройка установлена **согласованно** в `tsconfig.server.json` для вашего сервера и
`tsconfig.app.json` для ваших браузерных сборок. Несовпадающие значения приведут к поломке гидратации.

Если вы решите установить эту настройку в вашем tsconfig, мы рекомендуем устанавливать её только в `tsconfig.app.json`,
от которого по умолчанию наследуется `tsconfig.server.json`.

### Кастомный или Noop Zone.js пока не поддерживаются

Гидратация полагается на сигнал от Zone.js о том, что он стал стабильным внутри приложения, чтобы Angular мог начать
процесс сериализации на сервере или очистку после гидратации на клиенте для удаления невостребованных узлов DOM.

Предоставление кастомной или "noop" реализации Zone.js может привести к другому времени возникновения события "stable",
тем самым запуская сериализацию или очистку слишком рано или слишком поздно. Эта конфигурация пока не поддерживается
полностью, и вам может потребоваться скорректировать время события `onStable` в кастомной реализации Zone.js.

## Ошибки {#errors}

Существует несколько ошибок, связанных с гидратацией, с которыми вы можете столкнуться: от несоответствия узлов до
случаев, когда `ngSkipHydration` использовался на недопустимом хост-узле. Наиболее распространенный случай ошибки
возникает из-за прямого манипулирования DOM с использованием нативных API, в результате чего гидратация не может найти
или сопоставить ожидаемую структуру дерева DOM на клиенте с той, что была отрендерена сервером. Другой случай, когда вы
можете столкнуться с этим типом ошибки, был упомянут в разделе [Валидная структура HTML](#valid-html-structure) ранее.
Поэтому убедитесь, что HTML в ваших шаблонах использует валидную структуру, и вы избежите этого случая ошибки.

Полный справочник по ошибкам, связанным с гидратацией, см. в [Справочнике ошибок](/errors).

## Как пропустить гидратацию для конкретных компонентов {#how-to-skip-hydration-for-particular-components}

Некоторые компоненты могут работать некорректно с включенной гидратацией из-за некоторых вышеупомянутых проблем, таких
как [Прямое манипулирование DOM](#direct-dom-manipulation). В качестве обходного пути вы можете добавить атрибут
`ngSkipHydration` к тегу компонента, чтобы пропустить гидратацию всего компонента.

```angular-html
<app-example ngSkipHydration />
```

Альтернативно вы можете установить `ngSkipHydration` как привязку к хосту (host binding).

```typescript
@Component({
  ...
  host: {ngSkipHydration: 'true'},
})
class ExampleComponent {}
```

Атрибут `ngSkipHydration` заставит Angular пропустить гидратацию всего компонента и его дочерних элементов.
Использование этого атрибута означает, что компонент будет вести себя так, как будто гидратация не включена, то есть он
уничтожит и заново отрендерит себя.

ПОЛЕЗНО: Это исправит проблемы с рендерингом, но это означает, что для этого компонента (и его дочерних элементов) вы не
получите преимуществ гидратации. Вам нужно будет скорректировать реализацию вашего компонента, чтобы избежать паттернов,
ломающих гидратацию (например, прямое манипулирование DOM), чтобы иметь возможность удалить аннотацию пропуска
гидратации.

Атрибут `ngSkipHydration` можно использовать только на хост-узлах компонентов. Angular выдаст ошибку, если этот атрибут
будет добавлен к другим узлам.

Имейте в виду, что добавление атрибута `ngSkipHydration` к корневому компоненту вашего приложения фактически отключит
гидратацию для всего приложения. Будьте осторожны и вдумчивы при использовании этого атрибута. Он предназначен как
крайняя мера. Компоненты, которые ломают гидратацию, следует рассматривать как баги, которые необходимо исправить.

## Время гидратации и стабильность приложения

Стабильность приложения — важная часть процесса гидратации. Гидратация и любые процессы после гидратации происходят
только после того, как приложение сообщит о стабильности. Существует множество способов задержки стабильности. Примеры
включают установку таймаутов и интервалов, неразрешенные промисы и ожидающие микрозадачи. В таких случаях вы можете
столкнуться с ошибкой [Application remains unstable](errors/NG0506), которая указывает на то, что ваше приложение не
достигло стабильного состояния через 10 секунд. Если вы обнаружите, что ваше приложение не гидратируется сразу,
посмотрите, что влияет на стабильность приложения, и выполните рефакторинг, чтобы избежать этих задержек.

## I18N

ПОЛЕЗНО: По умолчанию Angular пропускает гидратацию для компонентов, использующих блоки i18n, фактически перерисовывая
эти компоненты с нуля.

Чтобы включить гидратацию для блоков i18n, вы можете добавить [`withI18nSupport`](/api/platform-browser/withI18nSupport)
в ваш вызов `provideClientHydration`.

```typescript
import {
  bootstrapApplication,
  provideClientHydration,
  withI18nSupport,
} from '@angular/platform-browser';
...

bootstrapApplication(AppComponent, {
  providers: [provideClientHydration(withI18nSupport())]
});
```

## Согласованный рендеринг на стороне сервера и клиента

Избегайте использования блоков `@if` и других условных конструкций, которые отображают разный контент при рендеринге на
стороне сервера и на стороне клиента, например, использование блока `@if` с функцией Angular `isPlatformBrowser`. Эти
различия в рендеринге вызывают сдвиги макета, негативно влияя на опыт конечного пользователя и показатели Core Web
Vitals.

## Сторонние библиотеки с манипуляцией DOM

Существует ряд сторонних библиотек, которые зависят от манипулирования DOM для рендеринга. D3 charts — яркий пример. Эти
библиотеки работали без гидратации, но они могут вызывать ошибки несоответствия DOM при включенной гидратации. На данный
момент, если вы столкнулись с ошибками несоответствия DOM при использовании одной из этих библиотек, вы можете добавить
атрибут `ngSkipHydration` к компоненту, который выполняет рендеринг с использованием этой библиотеки.

## Сторонние скрипты с манипуляцией DOM

Многие сторонние скрипты, такие как рекламные трекеры и аналитика, изменяют DOM до того, как может произойти гидратация.
Эти скрипты могут вызывать ошибки гидратации, поскольку страница больше не соответствует структуре, ожидаемой Angular.
По возможности старайтесь откладывать загрузку скриптов этого типа до завершения гидратации. Рассмотрите возможность
использования [`AfterNextRender`](api/core/afterNextRender), чтобы отложить скрипт до выполнения процессов
пост-гидратации.

## Инкрементальная гидратация

Инкрементальная гидратация — это продвинутая форма гидратации, которая позволяет более детально контролировать, когда
происходит гидратация. См. [руководство по инкрементальной гидратации](guide/incremental-hydration) для получения
дополнительной информации.
